<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🥶 福音雪镇 - 末日生存</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- ====== 模式选择遮罩 ====== -->
    <div id="mode-select-overlay">
        <div class="mode-panel">
<h1>🥶 福音雪镇 — 末日生存</h1>
            <p class="subtitle">8 位 AI 居民在极寒中挣扎求生</p>

            <!-- 模型选择 -->
            <div class="model-select-section">
                <div class="model-select-label">🧠 选择 AI 模型</div>
                <div class="model-options" id="model-options">
                    <label class="model-option" data-model="qwen3:4b-instruct-2507-q8_0">
                        <input type="radio" name="ai-model" value="qwen3:4b-instruct-2507-q8_0">
                        <div class="model-option-content">
                            <div class="model-option-name">Qwen3-4B Q8</div>
                            <div class="model-option-meta">4.3GB · 速度快 · 质量一般</div>
                        </div>
                    </label>
                    <label class="model-option selected" data-model="qwen3:14b-q8_0">
                        <input type="radio" name="ai-model" value="qwen3:14b-q8_0" checked>
                        <div class="model-option-content">
                            <div class="model-option-name">Qwen3-14B Q8</div>
                            <div class="model-option-meta">15GB · 推荐 · 质量好</div>
                        </div>
                    </label>
                    <label class="model-option" data-model="qwen3:14b-fp16">
                        <input type="radio" name="ai-model" value="qwen3:14b-fp16">
                        <div class="model-option-content">
                            <div class="model-option-name">Qwen3-14B FP16</div>
                            <div class="model-option-meta">29GB · 最高质量 · 可能需CPU辅助</div>
                        </div>
                    </label>
                </div>
                <div class="model-status" id="model-status"></div>
            </div>

            <div style="display:flex; gap:16px; justify-content:center; margin-top:24px; flex-wrap:wrap;">
                <button class="mode-btn agent" id="btn-mode-agent">
                    🤖 AI 观察模式
                    <div class="btn-sub">观察居民自主生活</div>
                </button>
                <button class="mode-btn reincarnation" id="btn-mode-reincarnation">
                    🔄 轮回模式
                    <div class="btn-sub">自动循环·前世记忆·越来越强</div>
                </button>
                <button class="mode-btn manual" id="btn-mode-debug">
                    🔧 Debug 模式
                    <div class="btn-sub">WASD 移动 / 检查碰撞</div>
                </button>
            </div>
            <!-- 轮回模式状态提示（由JS动态填充） -->
            <div id="reincarnation-status-hint" style="display:none; text-align:center; margin-top:12px; font-size:13px; color:#c084fc;">
                <span id="reincarnation-hint-text"></span>
                <label style="display:inline-flex; align-items:center; gap:4px; margin-left:12px; cursor:pointer; color:#aaa; font-size:12px;">
                    <input type="checkbox" id="chk-reset-reincarnation"> 从第1世重新开始
                </label>
            </div>

            <!-- 难度选择器（直接嵌入开始界面） -->
            <div id="difficulty-selector">
                <div class="difficulty-title">⚔️ 选择难度</div>
                <div class="difficulty-hint" style="text-align:center; font-size:11px; color:#888; margin:-4px 0 8px;">
                    难度仅在轮回模式生效 · 轮回中途无法切换，需勾选「从第1世重新开始」才能重选
                </div>
                <div class="difficulty-options" id="difficulty-options">
                    <!-- 由 JS 动态填充6个难度卡片 -->
                </div>
                <div class="difficulty-locked-text" id="difficulty-locked-text" style="display:none;">
                    🔒 轮回中难度已锁定，勾选「从第1世重新开始」可重新选择
                </div>
            </div>
        </div>
    </div>

    <!-- ====== 主布局 ====== -->
    <div id="app-layout">

        <!-- 顶部生存状态栏（整合控制按钮） -->
        <div id="survival-bar">
            <!-- 左区：核心生存信息 -->
            <div class="survival-section survival-left">
                <div class="survival-item" id="surv-day">
                    <span class="surv-icon">📅</span>
                    <span class="surv-label">天数</span>
                    <span class="surv-value" id="surv-day-val">第1天</span>
                </div>
                <div class="survival-item" id="surv-temp">
                    <span class="surv-icon">🌡️</span>
                    <span class="surv-label">温度</span>
                    <span class="surv-value" id="surv-temp-val">0°C</span>
                </div>
                <div class="survival-item" id="surv-weather">
                    <span class="surv-icon" id="surv-weather-icon">☁️</span>
                    <span class="surv-label">天气</span>
                    <span class="surv-value" id="surv-weather-val">阴天</span>
                </div>
            </div>

            <!-- 中区：控制按钮 -->
            <div class="survival-section survival-controls">
                <button id="btn-pause" class="ctrl-btn" title="暂停/继续">⏸️</button>
                <button id="btn-speed" class="ctrl-btn" title="切换速度">1×</button>
                <button id="btn-follow" class="ctrl-btn" title="自由/跟随切换">📷 自由</button>
                <select id="sel-follow-target" class="ctrl-select">
                    <option value="auto">自动切换</option>
                    <!-- 由 JS 动态填充 -->
                </select>
            </div>

            <!-- 右区：状态信息 -->
            <div class="survival-section survival-right">
                <div class="survival-item" id="surv-alive">
                    <span class="surv-icon">👥</span>
                    <span class="surv-label">存活</span>
                    <span class="surv-value" id="surv-alive-val">8/8</span>
                </div>
                <div class="survival-item" id="surv-furnace">
                    <span class="surv-icon">🔥</span>
                    <span class="surv-label">暖炉</span>
                    <span class="surv-value" id="surv-furnace-val">1座</span>
                </div>
                <div class="survival-item" id="surv-reincarnation" style="display:none; cursor:pointer;" title="点击查看往世结局">
                    <span class="surv-icon">🔄</span>
                    <span class="surv-label">轮回</span>
                    <span class="surv-value" id="surv-reincarnation-val">第1世</span>
                    <span style="font-size:10px; opacity:0.5; margin-left:2px;">▾</span>
                </div>
                <div class="survival-item" id="surv-difficulty" style="display:none;" title="当前难度等级">
                    <span class="surv-icon">⚙️</span>
                    <span class="surv-label">难度</span>
                    <span class="surv-value" id="surv-difficulty-val">简单</span>
                </div>
            </div>
        </div>

        <!-- 顶部物资栏 -->
        <div id="resource-bar">
            <div class="res-bar-item">
                <span class="res-bar-icon">🪵</span>
                <span class="res-bar-label">木柴</span>
                <span class="res-bar-gauge"><div class="res-bar-fill" id="res-wood-fill" style="width:50%"></div></span>
                <span class="res-bar-val" id="res-wood-val">20</span>
            </div>
            <div class="res-bar-item">
                <span class="res-bar-icon">🍞</span>
                <span class="res-bar-label">食物</span>
                <span class="res-bar-gauge"><div class="res-bar-fill" id="res-food-fill" style="width:40%"></div></span>
                <span class="res-bar-val" id="res-food-val">16</span>
            </div>
            <div class="res-bar-item">
                <span class="res-bar-icon">⚡</span>
                <span class="res-bar-label">电力</span>
                <span class="res-bar-gauge"><div class="res-bar-fill" id="res-power-fill" style="width:60%"></div></span>
                <span class="res-bar-val" id="res-power-val">30</span>
            </div>
            <div class="res-bar-item">
                <span class="res-bar-icon">🧱</span>
                <span class="res-bar-label">建材</span>
                <span class="res-bar-gauge"><div class="res-bar-fill" id="res-material-fill" style="width:20%"></div></span>
                <span class="res-bar-val" id="res-material-val">10</span>
            </div>
            <div class="res-bar-item res-bar-item-medkit">
                <span class="res-bar-icon">💊</span>
                <span class="res-bar-label">急救包</span>
                <span class="res-bar-val" id="res-medkit-val">0</span>
            </div>
            <div class="res-bar-divider"></div>
            <div class="res-bar-item">
                <span class="res-bar-icon">📋</span>
                <span class="res-bar-label">任务</span>
                <span class="res-bar-val" id="task-progress-val">0/0</span>
            </div>
        </div>

        <!-- 左侧：Agent 信息面板 -->
        <div id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">👥 居民</span>
                <span class="sidebar-time" id="sidebar-time">第1天 08:00</span>
            </div>
            <div id="agent-list">
                <!-- 由 JS 动态生成 -->
            </div>
        </div>

        <!-- 右侧事件日志面板 -->
        <div id="event-sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">📜 事件</span>
            </div>
            <div id="event-log"></div>
        </div>

        <!-- 聊天记录面板 -->
        <div id="chat-log-sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">💬 聊天记录</span>
                <button id="btn-save-debug-log" class="chat-log-clear-btn" title="保存Debug日志到服务器">💾</button>
                <button id="btn-clear-chat-log" class="chat-log-clear-btn" title="清空记录">🗑️</button>
            </div>
            <div id="chat-log-content"></div>
        </div>

        <!-- 中间：Canvas -->
        <div id="game-container">
            <canvas id="gameCanvas"></canvas>
            <div id="ui" class="ui-overlay">福音雪镇</div>

            <!-- 对话面板（Debug 模式用） -->
            <div id="dialogue-panel">
                <img class="portrait" id="dialogue-portrait" src="" alt="">
                <div class="npc-name" id="dialogue-name"></div>
                <div class="dialogue-text" id="dialogue-text"></div>
                <div class="dialogue-input-row" id="dialogue-input-row" style="display:none;">
                    <input type="text" id="dialogue-input" placeholder="说点什么..." autocomplete="off">
                    <button id="dialogue-send">发送</button>
                </div>
            </div>

            <!-- NPC 信息浮窗 -->
            <div id="npc-info-tooltip"></div>
        </div>
    </div>

    <!-- NPC 详情面板（点击居民卡片弹出） -->
    <div id="npc-detail-overlay" style="display:none;">
        <div id="npc-detail-panel">
            <div class="npc-detail-header">
                <div class="npc-detail-avatar" id="npc-detail-avatar"></div>
                <div class="npc-detail-info">
                    <div class="npc-detail-name" id="npc-detail-name"></div>
                    <div class="npc-detail-meta" id="npc-detail-meta"></div>
                </div>
                <button class="npc-detail-close" id="npc-detail-close">✕</button>
            </div>
            <div class="npc-detail-tabs">
                <button class="npc-tab active" data-tab="attributes">📊 属性</button>
                <button class="npc-tab" data-tab="schedule">📋 日程</button>
                <button class="npc-tab" data-tab="memory">💬 记录</button>
                <button class="npc-tab" data-tab="relations">❤️ 关系</button>
                <button class="npc-tab" data-tab="debug" id="npc-tab-debug" style="display:none;">🔍 Debug</button>
            </div>
            <div class="npc-detail-body">
                <div class="npc-tab-content active" id="tab-attributes"></div>
                <div class="npc-tab-content" id="tab-schedule"></div>
                <div class="npc-tab-content" id="tab-memory"></div>
                <div class="npc-tab-content" id="tab-relations"></div>
                <div class="npc-tab-content" id="tab-debug"></div>
            </div>
        </div>
    </div>

    <!-- 往世结局弹窗 -->
    <div id="past-lives-overlay" style="display:none;">
        <div id="past-lives-panel">
            <div class="past-lives-header">
                <span class="past-lives-title">🔄 轮回档案</span>
                <button class="past-lives-close" id="past-lives-close">✕</button>
            </div>
            <div class="past-lives-body" id="past-lives-body">
                <!-- 由JS动态填充 -->
            </div>
        </div>
    </div>

    <!-- Debug 模式底部提示 -->
    <div id="instructions" style="display:none;">WASD移动镜头 | E交互 | G网格 | Cmd+S保存</div>

    <!-- Debug 面板 -->
    <div id="debug-panel"></div>

    <!-- 聊天 UI（Debug 模式用） -->
    <div id="chat-container" class="chat-ui" style="display:none;">
        <input id="chat-input" type="text" placeholder="按 T 输入消息..." autocomplete="off">
        <button id="btn-send-chat">发送</button>
    </div>

    <div id="save-toast"></div>

    <script src="maps.js"></script>
    <script src="weather-system.js"></script>
    <script src="resource-system.js"></script>
    <script src="furnace-system.js"></script>
    <script src="death-system.js"></script>
    <script src="reincarnation-system.js"></script>
    <script src="difficulty-config.js"></script>
    <script src="task-system.js"></script>
    <script src="event-system.js"></script>
    <script src="npc.js"></script>
    <script src="dialogue.js"></script>
    <script src="aimode-logger.js"></script>
    <script src="game.js"></script>
</body>
</html>
