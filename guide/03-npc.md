# NPC 居民设计

## 核心居民（8 人）

| 角色 | 性别 | 年龄 | 职业 | 住所 | 性格 | 家庭关系 | 日常 |
|------|------|------|------|------|------|---------|------|
| **李婶** | ♀ | 42 | 杂货铺老板 | 公寓101 | 热心、健谈、爱操心 | 陆辰的妈妈 | 早起开店，中午广场，晚上酒馆聊天 |
| **赵大厨** | ♂ | 38 | 酒馆老板/大厨 | 公寓102 | 豪爽、好酒、讲义气 | — | 上午备料采购，中午到深夜酒馆全时段营业 |
| **王老师** | ♂ | 32 | 教师 | 公寓103 | 博学深邃、善于启发 | — | 上午学堂教课，午后公园读书，晚上酒馆聊天 |
| **老钱** | ♂ | 60 | 退休渔夫/镇长/人生导师 | 公寓201 | 慈祥、智慧深沉、善于提问 | 清璇的爷爷 | 公园晒太阳，找人聊天，晚上酒馆畅谈 |
| **苏医生** | ♂ | 35 | 镇医/心理咨询师 | 公寓202 | 温和、细心、成熟稳重 | — | 早上医院坐诊，下午巡诊/散步，晚上酒馆小坐 |
| **凌玥** | ♀ | 22 | 文艺演出/情绪疗愈师 | 公寓203 | 文艺、热情、爱自然 | — | 上午公园创作，下午广场演出，晚上酒馆找灵感 |
| **陆辰** | ♂ | 18 | 大学生（假期回乡） | 公寓301 | 阳光、聪明、爱冒险 | 李婶的儿子 | 上午帮忙/上课，下午公园冒险，晚上广场玩耍 |
| **清璇** | ♀ | 16 | 高中生/文学少女 | 公寓301 | 文静敏感、爱思考、浪漫 | 老钱的孙女 | 上午读书，下午公园写作思考，晚上酒馆找人讨论人生 |

## 家庭关系

- **李婶 → 陆辰（母子）**：李婶每天给陆辰零花钱（5~10），陆辰住公寓301，李婶住101。杂货铺老板娘的阳光大学生儿子——假期回乡帮忙
- **老钱 → 清璇（祖孙）**：老钱每天给清璇零花钱（5~10），老钱的哲学底蕴影响了清璇的文学气质。清璇是"文学少女"的设定与爷爷的智者身份完美呼应
- 零花钱机制：每天结算时，家长从存款中扣除一定金额转入孩子存款。如果家长存款不足，零花钱减少 → 孩子不开心 → 可能产生家庭矛盾事件

## 💕 情感关系网

### 中年暖心线：赵大厨（♂38）→ 李婶（♀42）
- 赵大厨暗恋李婶已久，每天给李婶留最好的菜，找借口去杂货铺
- 李婶丧夫多年有好感但怕闲话，男追女的经典戏码
- 陆辰对"准继父"态度：先排斥后接受

### 三角关系核心大戏：苏医生（♂35）vs 王老师（♂32）→ 凌玥（♀22）
- 苏医生：成熟稳重，默默关心凌玥健康，用医者身份接近
- 王老师：文艺知性，和凌玥聊艺术哲学很投缘
- 凌玥在两人之间摇摆不定，制造最大戏剧冲突

### 青春暗恋线：陆辰（♢18）↔ 清璇（♀16）
- 陆辰暗恋老钱的孙女清璇，清璇是高中生- 清璇对陆辰有好感，但性格文静害羞
- 老钱和李婶作为长辈暗中观察、催促，增加喜剧效果

### 吃瓜搅局王：老钱（♂60）
- 看穿所有人感情，时不时"无意"点拨
- 最操心孙女清璇的感情

## 💕 初始好感度（非对称）

| 关系 | 初始好感 | 说明 |
|------|---------|------|
| 赵大厨→李婶 | 75 | 暗恋已久 |
| 李婶→赵大厨 | 65 | 有好感但犹豫 |
| 苏医生→凌玥 | 70 | 暗恋 |
| 王老师→凌玥 | 68 | 暗恋 |
| 凌玥→苏医生 | 60 | 有好感 |
| 凌玥→王老师 | 62 | 有好感 |
| 陆辰→清璇 | 72 | 青春暗恋 |
| 清璇→陆辰 | 65 | 有好感 |
| 其他关系 | 50 | 中性（邻居关系） |

## 8人服务闭环

| 角色 | 主要贡献属性 | 服务内容 |
|------|------------|---------|
| 赵大厨 | 💪体力+🫀健康 | 餐饮全包（早餐/午餐/晚餐/夜宵/酒水），吃饭恢复体力 |
| 李婶 | 💰存款(物资枢纽) | 商品差价，物资流通中心 |
| 王老师 | 🧠智慧 | 教育，提升智慧 |
| 苏医生 | 🫀健康+🧠San值 | 治病（恢复健康）、**心理咨询**（恢复San值，+0.30/秒，花费~6元） |
| 凌玥 | ✨魅力+🧠San值 | **文艺演出**（14:00-16:00广场/19:00-21:00酒馆，恢复San值+0.20/秒，花费~1元） |
| 老钱 | 🧠智慧+💬情商 | 人生导师、镇长调解 |
| 陆辰 | — | 消费者/学生 |
| 清璇 | — | 消费者/学生 |

## 居民 AI 行为循环

```
每个居民的 think() 循环:
  ├── 1. 感知 (percept)
  │   ├── describe() → 当前位置文字描述
  │   ├── scanNearby() → 附近 64 格内的其他居民（+同场景远处NPC概览）
  │   └── getInterestPoints() → 当前场景的兴趣点
  │
  ├── 2. 日程匹配 (schedule)
  │   ├── 根据 gameTime 查找当前应做的活动
  │   └── 如果当前行动已完成 → 进入下一个日程
  │
  ├── 2.5 发疯检测 (crazy check)
  │   ├── San值<15 → 触发发疯状态（isCrazy）
  │   ├── 发疯时：随机乱走、说胡话、跳过日程/社交
  │   ├── 发疯惩罚：体力-0.08/秒、健康-0.03/秒、魅力-0.02/秒、情商-0.01/秒
  │   ├── 发疯社交影响：目击者好感度-2，自己对目击者好感度-1
  │   └── 恢复条件：San值≥30 或 发疯计时（~3小时）结束
  │
  ├── 3. 社交检测 (social)
  │   ├── 附近是否有其他居民？（64格范围 + 同场景远处NPC）
  │   ├── 关系好感度 > 阈值？
  │   ├── 冷却时间检查（同人 30 分钟内不重复对话）
  │   └── LLM 决定是否发起对话
  │
  ├── 4. 行动决策 (decide)
  │   ├── 发疯中 → 随机乱走（跳过正常决策）
  │   ├── 社交优先 → 走向对方 + 发起对话（支持走向远处同场景NPC）
  │   ├── 日程驱动 → 走向目标地点
  │   └── 空闲时 → 随机闲逛/回家
  │
  └── 5. 执行 (execute)
      ├── findPath() → A* 寻路
      ├── 移动动画
      └── 到达后触发交互/对话
```

## 好感度系统

```
好感度范围: 0 ~ 100
初始值: 50（中性）

变化触发:
  - 每次对话结束后: LLM 评估对话质量 → ±1~10
  - 帮助行为: +5
  - 冲突/争吵: -5~-15

好感度影响:
  - < 20: 主动回避，不发起对话
  - 20~40: 礼貌但冷淡
  - 40~70: 正常社交
  - 70~90: 友好，主动打招呼
  - > 90: 亲密，分享秘密/特殊对话
```

## 天气影响日程系统

NPC 的日程表在下雨天会自动调整（`_getWeatherAdjustedEntry()`）：

- **户外目标集合**：`park`、`park_bench`、`plaza`
- 下雨时，原本前往户外的日程会自动替换为室内替代目标
- 替代目标使用 NPC id + 时段种子确定，保证同一时段内目标稳定
- 如果 NPC 已经在户外时天气突然变雨，会**强制重新导航**回室内
- think prompt 中强化天气规则：AI 在下雨时不会想去户外

### 雨天室内替代池

| 替代目标 | 替代描述 |
|----------|---------|
| tavern_door（酒馆） | 下雨了，去酒馆待着 |
| shop_door（杂货铺） | 下雨了，去杂货铺待着 |
| clinic_door（医院） | 下雨了，去医院坐坐 |
| apartment_door（公寓） | 下雨了，回公寓待着 |